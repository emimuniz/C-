<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    <h2 id="titulo">Cadastrar Aluno</h2>
    <div><label>Nome:</label><input id = "nome" type="text"></div>
    <div><label>Sobrenome:</label><input id = "sobrenome" type="text"></div>
    <div><label>Telefone:</label><input id = "telefone" type="text"></div>
    <div><label>RA:</label><input id = "ra" type="text"></div>
    <div>
        <button  id ="btnSalvar" onclick="Cadastrar()">Cadastrar</button>
        <button id ="btnCancelar" onclick="Cancelar()">Limpar</button>
    </div>
    <table border="1">
        <thead>
            <tr>
                <td>Nome</td>
                <td>Sobrenome</td>
                <td>Telefone</td>
                <td>RA</td>
                <td>Opções</td>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table> 
    <script type="text/javascript">
        var tbody = document.querySelector('table tbody');
        var aluno;


        function Cadastrar(){
            tbody.innerHTML = '';

            aluno.nome = document.querySelector('#nome').value;
            aluno.sobrenome = document.querySelector('#sobrenome').value;          
            aluno.telefone = document.querySelector('#telefone').value;
            aluno.ra = document.querySelector('#ra').value;
           

          if(aluno.id === undefined || aluno.id === 0){
            salvarEstudante('POST', 0, aluno);
          }
          else{
            salvarEstudante('PUT', aluno.id, aluno);
          }

          carregarEstudante();
        }

        function Cancelar() {
            var btnSalvar = document.querySelector("#btnSalvar");
            var btnCancelar = document.querySelector("#btnCancelar");
            var titulo = document.querySelector("#titulo");

            btnSalvar.textContent = 'Cadastrar';
            btnCancelar.textContent = 'Limpar';
            titulo.textContent = 'Cadastrar Aluno';

             document.querySelector('#nome').value = '';
             document.querySelector('#sobrenome').value = '';           
             document.querySelector('#telefone').value = '';
             document.querySelector('#ra').value = '';
        }

        function carregarEstudante(){
            tbody.innerHTML = '';
            var xhr = new XMLHttpRequest();

            xhr.open("GET", `http://localhost:58548/api/aluno/` , true);

            xhr.onload = function(){
                var estudante = JSON.parse(this.responseText);
                for(var indice in estudante){
                    adicionaLinha(estudante[indice]);
                }
            }

             xhr.send();
        }

        function salvarEstudante(metodo, id, corpo){
            var xhr = new XMLHttpRequest();

            if(id === undefined) id = '';


            //esperando ser recebido e retornado
            xhr.open(metodo, `http://localhost:58548/api/aluno/${id}` , false);

                xhr.setRequestHeader('content-type', 'application/json');
                xhr.send(JSON.stringify(corpo));
        }
        
        carregarEstudante();

        function editarEstudante(estudante){
            var btnSalvar = document.querySelector("#btnSalvar");
            var btnCancelar = document.querySelector("#btnCancelar");
            var titulo = document.querySelector("#titulo");

            btnSalvar.textContent = 'Salvar';
            btnCancelar.textContent = 'Cancelar';
            titulo.textContent = `Editar Aluno ${estudante.nome}`;

             document.querySelector('#nome').value = estudante.nome
             document.querySelector('#sobrenome').value = estudante.sobrenome;           
             document.querySelector('#telefone').value = estudante.telefone
             document.querySelector('#ra').value = estudante.ra;

            aluno = estudante;
        }

        function adicionaLinha(estudante){
            var trow = `
                        <tr>
                            <td>${estudante.nome}</td>
                            <td>${estudante.sobrenome}</td>
                            <td>${estudante.telefone}</td>
                            <td>${estudante.ra}</td>
                            <td><button onclick='editarEstudante(${JSON.stringify(estudante)})'>Editar</button></td>
                            <td><button onclick='DeletarEstudante(${estudante.id})'>Deletar</button></td>
                        </tr>
         
                       `
             tbody.innerHTML += trow;
        }
    </script>  
</body>
</html>